<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MailMind - Inbox</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.85);
      --text-muted: rgba(255, 255, 255, 0.6);
      --shadow-primary: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -2;
    }

    body::before {
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
    }

    body::after {
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
      z-index: -1;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 2rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .email {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      margin-bottom: 2rem;
      padding: 2rem;
      box-shadow: var(--shadow-primary);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .email:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
    }

    .email-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .email-section {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--glass-border);
      padding: 1.2rem;
      border-radius: 14px;
      backdrop-filter: blur(10px);
      position: relative;
    }

    .email-section::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 3px;
      background: var(--accent-gradient);
      border-radius: 0 14px 14px 0;
    }

    .email-section strong {
      display: block;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    pre {
      white-space: pre-wrap;
      margin: 0;
      color: var(--text-secondary);
      font-family: 'Inter', sans-serif;
      line-height: 1.6;
    }

    textarea {
      width: 100%;
      height: 120px;
      background: rgba(255, 255, 255, 0.06);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 1rem;
      resize: vertical;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      line-height: 1.5;
      backdrop-filter: blur(10px);
      outline: none;
      transition: border-color 0.3s ease;
    }

    textarea:focus {
      border-color: rgba(102, 126, 234, 0.6);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      margin: 10px 10px 0 0;
      padding: 0.8rem 1.6rem;
      background: var(--primary-gradient);
      color: #ffffff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    #emailList {
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      h1 {
        font-size: 2rem;
      }

      .email-content {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .email {
        padding: 1.5rem;
      }

      button {
        padding: 0.7rem 1.2rem;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 0.5rem;
      }

      h1 {
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
      }

      .email {
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .email-section {
        padding: 1rem;
      }

      button {
        width: 100%;
        margin: 0.5rem 0 0 0;
      }
    }
  </style>
</head>
<body>
  <h1>Your Inbox</h1>
  <div id="emailList">Loading emails...</div>
  <script>
    const accessToken = localStorage.getItem("accessToken");
    const emailList = document.getElementById("emailList");
    const apiKey = "AIzaSyAPkVWClLtqK-zJkRKhAuwLbNakB9YT4jQ";
    async function useGemini(prompt) {
      const res = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        }
      );
      const data = await res.json();
      return data?.candidates?.[0]?.content?.parts?.[0]?.text || "Gemini Error";
    }

    async function generateCard(email) {
      const card = document.createElement("div");
      card.className = "email";

      const emailContent = document.createElement("div");
      emailContent.className = "email-content";

      const summaryDiv = document.createElement("div");
      summaryDiv.className = "email-section";

      const replyDiv = document.createElement("div");
      replyDiv.className = "email-section";

  const summaryPrompt = `
You are an intelligent email assistant.

Read the full email message below, which may also contain extracted content from attachments like PDF or DOCX files. Summarize the key idea in detail. Do not include greetings or explanations.

Email content:
${email.body}
`;
const summaryText = await useGemini(summaryPrompt);

 const replyPrompt = `
Based on the email and its attachment content (if any), write a professional reply.

Don't include greetings or sign-offs â€” just the response body. Acknowledge if there's an attachment. Keep it useful and relevant.

Email:
${email.body}
`;
const replyText = await useGemini(replyPrompt);


      summaryDiv.innerHTML = `<strong> Summary</strong><pre>${summaryText}</pre>`;
      replyDiv.innerHTML = `<strong>Auto Reply</strong><textarea>${replyText}</textarea>`;

      const buttonsDiv = document.createElement("div");

      const sendBtn = document.createElement("button");
      sendBtn.textContent = "Send Reply";

sendBtn.onclick = async () => {
  const replyContent = replyDiv.querySelector("textarea").value;

  const rawMessage = [
  `From: me`,
  `To: ${email.from}`,
  `Subject: Re: ${email.subject || ""}`,
  `MIME-Version: 1.0`,
  `Content-Type: text/plain; charset="UTF-8"`,
  '',
  replyContent
].join('\n');
  function base64EncodeUnicode(str) {
    return btoa(unescape(encodeURIComponent(str)))
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, '');
  }

  const encodedMessage = base64EncodeUnicode(rawMessage);

  const response = await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages/send", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ raw: encodedMessage })
  });

  if (response.ok) {
    alert("Reply sent successfully.");
  } else {
    alert("Failed to send reply.");
    console.error(await response.text());
  }
};
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
     deleteBtn.onclick = async () => {
  // Debug current token
  console.log("Current token:", accessToken ? "Exists" : "Missing");
  
  if (!accessToken) {
    alert("Please sign in again");
    window.location.href = "/auth/google";
    return;
  }

  try {
    const response = await fetch(`https://www.googleapis.com/gmail/v1/users/me/messages/${email.id}`, {
      method: "DELETE",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      }
    });

    if (response.status === 204) {
      card.remove();
      alert("Deleted successfully");
    } else {
      const error = await response.json();
      console.error("Full error response:", error);
      alert(`Error: ${error.error?.message || 'Unknown error'}`);
    }
  } catch (error) {
    console.error("Request failed:", error);
    alert("Network error - check console");
  }
};
      const translateBtn = document.createElement("button");
      translateBtn.textContent = "Translate Summary";
      translateBtn.onclick = async () => {
        const lang = prompt("Translate summary to which language (e.g., Hindi)?");
        if (!lang) return;
        const translated = await useGemini(`Translate this into ${lang}:\n${summaryText}`);
        summaryDiv.innerHTML = `<strong> Translated Summary (${lang})</strong><pre>${translated}</pre>`;
      };

      buttonsDiv.appendChild(sendBtn);
      buttonsDiv.appendChild(deleteBtn);
      buttonsDiv.appendChild(translateBtn);

      emailContent.appendChild(summaryDiv);
      emailContent.appendChild(replyDiv);
      card.appendChild(emailContent);
      card.appendChild(buttonsDiv);

      emailList.appendChild(card);
    }

    if (!accessToken) {
      emailList.innerText = "Access token missing.";
    } else {
      fetch("http://localhost:3000/emails", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ accessToken })
      })
        .then(res => res.json())
        .then(async data => {
          if (!data.success) {
            emailList.innerText = "Failed to load emails.";
            return;
          }

          emailList.innerHTML = "";
          for (const msg of data.messages) {
            const res = await fetch("http://localhost:3000/email-details", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ accessToken, messageId: msg.id })
            });

            const emailData = await res.json();
            await generateCard(emailData);
          }
        })
        .catch(() => emailList.innerText = "Error loading inbox.");
    }
  </script>
</body>
</html>